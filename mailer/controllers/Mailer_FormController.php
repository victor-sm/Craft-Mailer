<?phpnamespace Craft;/** * Contact Form controller */class Mailer_FormController extends BaseController{	/**	 * @var Allows anonymous access to this controller's actions.	 * @access protected	 */	protected $allowAnonymous = false;	/**	 * Sends an email based on the posted params.	 *	 */	public function actionSend()	{		//Is CpRequest?		if (craft()->request->isCpRequest() == false)		{			return false;		}		$this->requirePostRequest();				//Vars		$formData 					= new Mailer_FormModel();		$formData->sender_name 		= craft()->request->getPost('mailer_sender_name');		$formData->sender_mail 		= craft()->request->getPost('mailer_sender_mail');		$formData->subject 			= craft()->request->getPost('mailer_subject');		$formData->htmlBody 		= craft()->request->getPost('mailer_htmlBody');		$formData->attachment 		= \CUploadedFile::getInstanceByName('mailer_attachment');		$formData->sendto_custom	= craft()->request->getPost('mailer_sendto_custom');			$formData->to 			= craft()->request->getPost('mailer_to');			$formData->cc 			= craft()->request->getPost('mailer_cc');			$formData->bcc 			= craft()->request->getPost('mailer_bcc');						$formData->sendto_usergroups = craft()->request->getPost('mailer_sendto_usergroups');			$formData->usergroups 	 = craft()->request->getPost('mailer_usergroups');						$formData->sendto_users		= craft()->request->getPost('mailer_sendto_users');			$formData->users 		= craft()->request->getPost('mailer_users');		//Model Validation		if (!$formData->validate()) {			//Log			MailerPlugin::log('FormData validation failed: "'. implode('; ', $formData->getErrors()) .'"', LogLevel::Info);						if (craft()->request->isAjaxRequest()) {				return $this->returnErrorJson( $formData->getErrors() );			}			else {				//SetError				craft()->userSession->setError( Craft::t('There was a problem with your submission, please check the form and try again!') );								//Set UserElement				if ( !$formData->hasErrors('users') && !empty($formData->users) ) {					$users_element_array = array();					foreach ($formData->users as $user) {						$users_element_array[] = craft()->users->getUserById( $user );					}					$formData->users = $users_element_array;				}				//Return formData				craft()->urlManager->setRouteVariables(array(					'formData' => $formData				));			}		}		else		{			//Log			MailerPlugin::log('FormData valid', LogLevel::Info);						//Service			$mailer_service = craft()->mailer_main->newMailer_fromForm($formData);						//Return			if ($mailer_service) {				//Success				if (craft()->request->isAjaxRequest()) {					return $this->returnJson( array('success' => true) );				}				else {					craft()->userSession->setNotice( Craft::t('The Mailer has successfully started') );					return true;				}			}			else {				//Something has gone wrong				craft()->userSession->setError( Craft::t('There was an internal error, please check the logs for more information!') );			}		}	}	/**	 * Delete all LogRecords	 *	 */	public function actionClearLog()	{		//Is CpRequest?		if (craft()->request->isCpRequest() == false)		{			return false;		}		//Delete all LogRecords		$logs = new Mailer_LogRecord;		$logs->deleteAll();	}	/**	 * Export selected Users as CSV	 *	 */	public function actionExport()	{		//Is CpRequest?		if (craft()->request->isCpRequest() == false)		{			return false;		}		$this->requirePostRequest();				//Vars		$exportData = new Mailer_ExportModel();		$exportData->sendto_usergroups  = craft()->request->getPost('mailer_sendto_usergroups');		$exportData->usergroups 	 	= craft()->request->getPost('mailer_usergroups');			$exportData->sendto_users		= craft()->request->getPost('mailer_sendto_users');		$exportData->users 			 	= craft()->request->getPost('mailer_users');		//Validate		if ($exportData->validate())		{			//Notice			craft()->userSession->setNotice( Craft::t('Export has successfully started') );			//Get CSV			$csv = craft()->mailer_main->createUserCSV($exportData);			//Download			header('Content-Type: text/csv');			header('Content-Disposition: attachment;filename=UserData.csv');			echo $csv;			die();		}		else 		{			//Something has gone wrong			craft()->userSession->setError( Craft::t('There was a problem with your submission, please check the form and try again!') );		}			}}